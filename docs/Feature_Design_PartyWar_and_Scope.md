# ðŸ”® åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆï¼šå…šäº‰ç»Ÿè®¡ & é™å®šèŒƒå›´å‡ºé¢˜

ï¼ˆå·²æ›´æ–°ï¼šå¢žåŠ é˜²åˆ·ç­–ç•¥ã€éžæ³•æ•°æ®æ¸…æ´—ã€ä»¥åŠé«˜æ€§èƒ½ç¼“å­˜æœºåˆ¶ï¼‰

---

## æ ¸å¿ƒåŠŸèƒ½ï¼šæŠ•ç¥¨ä¸Žç»Ÿè®¡ (Voting & Stats)

ç”¨æˆ·åœ¨åˆ›å»ºæ¨¡ç‰ˆæ—¶ï¼Œå¯ä»¥é€‰æ‹©å¼€å¯â€œæŠ•ç¥¨ç»Ÿè®¡æ¨¡å¼â€ã€‚
ä¸€æ—¦å¼€å¯ï¼Œè¯¥æ¨¡ç‰ˆçš„æ‰€æœ‰æœ‰æ•ˆå¡«å†™è®°å½•ï¼ˆSaveï¼‰å°†è¢«è§†ä¸ºâ€œæŠ•ç¥¨å•â€ã€‚

### 1. åˆ¶è¡¨æµç¨‹ (Create Template)

åœ¨ `CreateTemplate.vue` ä¸­æ–°å¢žå¼€å…³ï¼š
*   **[Switch] å¼€å¯å…¨æ°‘ç»Ÿè®¡**
*   **æç¤ºæ–‡æ¡ˆ**ï¼šâ€œå¼€å¯åŽï¼Œç³»ç»Ÿå°†ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·çš„å¡«è¡¨ç»“æžœï¼Œå¹¶ç”Ÿæˆè¯¥æ¨¡ç‰ˆçš„å¤§ä¼—å¿ƒç†åˆ†å¸ƒå›¾ã€‚ä¸ºäº†ä¿è¯æ•°æ®è´¨é‡ï¼Œå‚ä¸Žç»Ÿè®¡çš„ç”¨æˆ·éœ€è¦è¢«æ ‡è®°ï¼ˆåŒ¿åæŒ‡çº¹ï¼‰ã€‚â€

**æ•°æ®ç»“æž„å˜æ›´ (`types/grid.ts`)**:

```typescript
export interface TemplateConfig {
    cols: number
    items: string[]
    
    // [New] æŠ•ç¥¨é…ç½®
    voting?: {
        enabled: boolean  // æ˜¯å¦å¼€å¯
    }
}
```

### 2. æŠ•ç¥¨ä¸Žé˜²åˆ·é€»è¾‘ (Voting & Anti-Abuse)

#### A. èº«ä»½è¯†åˆ« (Identity Resolution)
æˆ‘ä»¬ä¸å¼ºåˆ¶ç™»å½•ï¼Œé‡‡ç”¨ **"LocalStorage Token + IP é™æµ"** ç­–ç•¥ï¼Œè§£å†³å®¿èˆ/å…¬å¸ NAT é—®é¢˜ã€‚

1.  **æµè§ˆå™¨ä»¤ç‰Œ (v_token)**: ä¸»è¦è¯†åˆ« IDã€‚ç”¨æˆ·é¦–æ¬¡è®¿é—®ç”Ÿæˆ UUIDï¼Œå­˜åœ¨æœ¬åœ°ã€‚
2.  **IP è¾…åŠ©é™æµ**:
    *   ä¸ºäº†é˜²æ­¢åŒä¸€ä¸ªå¯å®¤çš„åŒå­¦è¢«è¯¯æ€ï¼Œæˆ‘ä»¬**å…è®¸**ç›¸åŒ IP + UA çš„æäº¤ã€‚
    *   **ä½†æ˜¯**ï¼Œè®¾å®šé˜ˆå€¼ï¼š**1å°æ—¶å†…ï¼ŒåŒä¸€ IP + UA åªèƒ½æäº¤ 10 æ¬¡æœ‰æ•ˆç¥¨**ã€‚è¶…è¿‡åˆ™ä¸´æ—¶å°ç¦è¯¥ IPã€‚

#### B. æ•°æ®æœ‰æ•ˆæ€§ (Data Validity)
**åªæœ‰â€œæ­£è§„å†›â€æ‰èƒ½ä¸Šæ¦œ**ã€‚
*   åœ¨ç»Ÿè®¡æŸ¥è¯¢æ—¶ï¼Œå¼ºåˆ¶è¦æ±‚ `bangumi_id > 0` (æˆ–è€…æœªæ¥æ‰©å……çš„å…¶ä»–å®˜æ–¹ ID)ã€‚
*   é˜²æ­¢ç”¨æˆ·åœ¨ä¸€ä¸ªæ ¼å­é‡Œå¡« â€œaaaâ€ æˆ– â€œä¸çŸ¥é“â€ æ±¡æŸ“æ¦œå•ã€‚

### 3. é«˜æ€§èƒ½ç»Ÿè®¡æž¶æž„ (Performance & Caching)

**âŒ æ‹’ç»æ¯æ¬¡æŸ¥è¯¢éƒ½è·‘ SQL èšåˆ**ã€‚
**âœ… é‡‡ç”¨ "Cache-Aside" + "D1 ç¼“å­˜è¡¨" ç­–ç•¥**ã€‚

æˆ‘ä»¬ä¸å¼•å…¥ Redis/KVï¼Œç›´æŽ¥ç”¨ D1 æ–°å»ºä¸€å¼ ç¼“å­˜è¡¨ï¼Œåˆ©ç”¨å…¶é«˜è¯»æ€§èƒ½ã€‚

#### Database Schema Update

æ–°å¢žè¡¨ `statistics_cache`:

| å­—æ®µ | ç±»åž‹ | è¯´æ˜Ž |
| :--- | :--- | :--- |
| `template_id` | TEXT | æ¨¡ç‰ˆ ID |
| `period` | TEXT | `24h` (æ—¥æ¦œ) / `week` (å‘¨æ¦œ) / `all` (æ€»æ¦œ) |
| `data` | JSON | é¢„è®¡ç®—å¥½çš„ Top List (æ¯ä¸ªæ ¼å­å‰ 3 å) |
| `updated_at` | INT | ä¸Šæ¬¡æ›´æ–°æ—¶é—´æˆ³ |
| **P_Key** | | (`template_id`, `period`) |

#### ç¼“å­˜æ›´æ–°ç­–ç•¥ (TTL Strategy)

æˆ‘ä»¬è®¾å®šä¸åŒçš„æ›´æ–°é¢‘çŽ‡ï¼ˆTTLï¼‰ï¼š
*   **æ—¥æ¦œ (24h)**: æ¯ **3å°æ—¶** æ›´æ–°ä¸€æ¬¡ã€‚
*   **å‘¨æ¦œ (Week)**: æ¯ **6å°æ—¶** æ›´æ–°ä¸€æ¬¡ã€‚
*   **æ€»æ¦œ (All)**: æ¯ **12å°æ—¶** æ›´æ–°ä¸€æ¬¡ã€‚

#### åŽç«¯é€»è¾‘ (Stale-While-Revalidate Pattern)

åˆ©ç”¨ Cloudflare Workers çš„ `context.waitUntil()` ç‰¹æ€§ï¼Œå®žçŽ° **0ms å»¶è¿Ÿ** æ›´æ–°ã€‚

1.  **Check Cache**: `SELECT data, updated_at FROM statistics_cache ...`
2.  **Scenario A: å‘½ä¸­ä½†è¿‡æœŸ (Stale Hit)**
    *   æ¡ä»¶: æ•°æ®å­˜åœ¨ï¼Œä½† `now - updated_at > TTL`ã€‚
    *   **Action 1 (Immediate)**: ç›´æŽ¥è¿”å›žæ—§æ•°æ® (`data`) ç»™å‰ç«¯ã€‚ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°ä»»ä½•å»¶è¿Ÿã€‚
    *   **Action 2 (Background)**: è°ƒç”¨ `context.waitUntil(doHeavySQLAndUpdate(...))`ã€‚
        *   Cloudflare ä¼šåœ¨å“åº”è¿”å›žåŽï¼Œç»§ç»­åœ¨åŽå°è¿è¡Œè¿™ä¸ª Promiseï¼Œç›´åˆ° SQL è·‘å®Œå¹¶æ›´æ–°ç¼“å­˜è¡¨ã€‚
3.  **Scenario B: æœªå‘½ä¸­ (Cache Miss)**
    *   æ¡ä»¶: æ•°æ®ä¸å­˜åœ¨ï¼ˆè¯¥æ¨¡ç‰ˆç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼‰ã€‚
    *   **Action**: åªèƒ½åŒæ­¥ç­‰å¾… SQL è·‘å®Œï¼Œæˆ–è€…è¿”å›ž `{ status: "calculating" }` è®©å‰ç«¯å±•ç¤º Loading åŠ¨ç”»å¹¶é‡è¯•ã€‚

### 4. ç»Ÿè®¡æŸ¥è¯¢ SQL (The Heavy Lifter)

è¿™æ˜¯é‚£ä¸ªâ€œæ˜‚è´µâ€ä½†å¶å°”æ‰è·‘ä¸€æ¬¡çš„ SQLï¼š

```sql
SELECT 
    i.slot_label, 
    i.character_name, 
    i.bangumi_id, 
    i.image_url,
    COUNT(DISTINCT s.user_hash) as vote_count
FROM save_items i
JOIN saves s ON i.save_id = s.id
WHERE s.template_id = ? 
  AND i.bangumi_id IS NOT NULL AND i.bangumi_id != 0 -- æ ¸å¿ƒï¼šåªç»Ÿè®¡æ­£è§„è§’è‰²
  -- AND s.created_at ... (æ ¹æ®æ—¥æ¦œ/å‘¨æ¦œè¿‡æ»¤æ—¶é—´)
GROUP BY i.slot_label, i.bangumi_id
HAVING vote_count > 1
ORDER BY i.slot_label, vote_count DESC
```

---

## ðŸš€ å®žæ–½æ­¥éª¤

1.  **Schema**: åˆ›å»º `statistics_cache` è¡¨ã€‚
2.  **API**: å®žçŽ° `/api/stats`ï¼Œå¸¦ä¸Šç¼“å­˜æ£€æŸ¥é€»è¾‘ã€‚
3.  **Frontend**: å¯¹æŽ¥å±•ç¤ºã€‚
